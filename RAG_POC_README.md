# RAGæ£€ç´¢å¼•æ“ (FAISS) POC ä½¿ç”¨æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

æœ¬POCï¼ˆæ¦‚å¿µéªŒè¯ï¼‰é¡¹ç›®å®ç°äº†ä¸€ä¸ªåŸºäºFAISSçš„å‘é‡æ£€ç´¢å¼•æ“ï¼Œä¸“é—¨ç”¨äºè¯­éŸ³è¯†åˆ«ç³»ç»Ÿä¸­çš„çƒ­è¯é¢„æµ‹å’Œå¢å¼ºåŠŸèƒ½ã€‚è¯¥æœåŠ¡é‡‡ç”¨è½»é‡çº§çš„å¾®æœåŠ¡æ¶æ„ï¼Œæä¾›é«˜æ•ˆçš„è¯­ä¹‰ç›¸ä¼¼åº¦æœç´¢èƒ½åŠ›ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ” **å‘é‡æ£€ç´¢èƒ½åŠ›**

- åŸºäº **sentence-transformers/all-MiniLM-L6-v2** æ¨¡å‹è¿›è¡Œæ–‡æœ¬å‘é‡åŒ–
- ä½¿ç”¨ **FAISS IndexFlatIP** å®ç°é«˜æ•ˆçš„ä½™å¼¦ç›¸ä¼¼åº¦æœç´¢
- æ”¯æŒå¤šç”¨æˆ·éš”ç¦»çš„ç´¢å¼•ç®¡ç†

### ğŸ’¾ **ç´¢å¼•æŒä¹…åŒ–**

- è‡ªåŠ¨ä¿å­˜/åŠ è½½ç”¨æˆ·å‘é‡ç´¢å¼•åˆ°æœ¬åœ°æ–‡ä»¶
- æ™ºèƒ½ç¼“å­˜æœºåˆ¶ï¼Œé¿å…é‡å¤è®¡ç®—
- æ”¯æŒå¢é‡æ›´æ–°å’Œç´¢å¼•é‡å»º

### ğŸš€ **é«˜æ€§èƒ½è®¾è®¡**

- å†…å­˜ä¸­ç´¢å¼•ç¡®ä¿æ¯«ç§’çº§æŸ¥è¯¢å“åº”
- æ‰¹é‡å‘é‡åŒ–å¤„ç†æå‡æ„å»ºæ•ˆç‡
- è½»é‡çº§æ¨¡å‹ï¼ˆ~90MBï¼‰å¹³è¡¡é€Ÿåº¦ä¸å‡†ç¡®æ€§

### ğŸ”’ **å®‰å…¨ä¸éš”ç¦»**

- åŸºäºJWTçš„ç”¨æˆ·è®¤è¯
- ç”¨æˆ·é—´æ•°æ®å®Œå…¨éš”ç¦»
- RESTful APIè®¾è®¡ï¼Œæ˜“äºé›†æˆ

## æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RAGæ£€ç´¢å¼•æ“æ¶æ„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  FastAPI Router (/rag/*)                                   â”‚
â”‚  â”œâ”€â”€ /search          - å‘é‡ç›¸ä¼¼åº¦æœç´¢                      â”‚
â”‚  â”œâ”€â”€ /suggestions     - æ™ºèƒ½çƒ­è¯å»ºè®®                        â”‚
â”‚  â”œâ”€â”€ /index/stats     - ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯                        â”‚
â”‚  â”œâ”€â”€ /index/rebuild   - é‡å»ºç”¨æˆ·ç´¢å¼•                        â”‚
â”‚  â””â”€â”€ /model/info      - æ¨¡å‹ä¿¡æ¯æŸ¥è¯¢                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  RAGService (æ ¸å¿ƒæœåŠ¡å±‚)                                    â”‚
â”‚  â”œâ”€â”€ SentenceTransformer  - æ–‡æœ¬å‘é‡åŒ–                     â”‚
â”‚  â”œâ”€â”€ FAISS IndexFlatIP   - å‘é‡ç´¢å¼•ä¸æœç´¢                   â”‚
â”‚  â”œâ”€â”€ ç´¢å¼•æŒä¹…åŒ–ç®¡ç†        - æ–‡ä»¶å­˜å‚¨ä¸åŠ è½½                  â”‚
â”‚  â””â”€â”€ ç”¨æˆ·æ•°æ®éš”ç¦»         - å¤šç”¨æˆ·æ”¯æŒ                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å­˜å‚¨å±‚                                                     â”‚
â”‚  â”œâ”€â”€ temp/rag_indices/   - ç´¢å¼•æ–‡ä»¶å­˜å‚¨                     â”‚
â”‚  â”‚   â”œâ”€â”€ user_xxx.index     - FAISSç´¢å¼•æ–‡ä»¶                 â”‚
â”‚  â”‚   â””â”€â”€ user_xxx.metadata  - å…ƒæ•°æ®JSONæ–‡ä»¶                â”‚
â”‚  â””â”€â”€ SQLite Database     - çƒ­è¯æ•°æ®æŒä¹…åŒ–                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿å·²å®‰è£…å¿…è¦çš„ä¾èµ–ï¼š

```bash
# è¿›å…¥åç«¯ç›®å½•
cd asr_system_backend

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 2. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨FastAPIæœåŠ¡
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 3. éªŒè¯æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥RAGæœåŠ¡å¥åº·çŠ¶æ€
curl http://localhost:8000/rag/health
```

é¢„æœŸå“åº”ï¼š

```json
{
  "status": "healthy",
  "service": "RAG Vector Search Engine", 
  "version": "1.0.0",
  "initialized": true
}
```

## APIæ¥å£è¯¦ç»†è¯´æ˜

### ğŸ” å‘é‡æœç´¢æ¥å£

**POST** `/rag/search`

æ ¹æ®æŸ¥è¯¢æ–‡æœ¬è¿›è¡Œå‘é‡ç›¸ä¼¼åº¦æœç´¢ï¼Œè¿”å›æœ€ç›¸å…³çš„çƒ­è¯ã€‚

**è¯·æ±‚å‚æ•°ï¼š**

```json
{
  "query": "äººå·¥æ™ºèƒ½æŠ€æœ¯",
  "top_k": 5,
  "threshold": 0.3
}
```

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "query": "äººå·¥æ™ºèƒ½æŠ€æœ¯",
  "results": [
    {
      "word": "æœºå™¨å­¦ä¹ ",
      "weight": 8,
      "similarity": 0.85,
      "rank": 1
    },
    {
      "word": "æ·±åº¦å­¦ä¹ ",
      "weight": 9,
      "similarity": 0.82,
      "rank": 2
    }
  ],
  "total_found": 2,
  "processing_time_ms": 12.5
}
```

### ğŸ“Š ç´¢å¼•ç»Ÿè®¡æ¥å£

**GET** `/rag/index/stats`

è·å–å½“å‰ç”¨æˆ·çš„ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ã€‚

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "user_id": "user123",
  "total_hotwords": 156,
  "index_dimension": 384,
  "is_initialized": true,
  "last_updated": "2025-07-11T15:30:00"
}
```

### ğŸ”„ ç´¢å¼•ç®¡ç†æ¥å£

**POST** `/rag/index/rebuild`

å¼ºåˆ¶é‡å»ºç”¨æˆ·çš„å‘é‡ç´¢å¼•ã€‚

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "success": true,
  "message": "ç´¢å¼•é‡å»ºæˆåŠŸï¼ŒåŒ…å« 156 ä¸ªçƒ­è¯",
  "details": {
    "user_id": "user123",
    "hotword_count": 156,
    "dimension": 384
  }
}
```

### ğŸ’¡ æ™ºèƒ½å»ºè®®æ¥å£

**GET** `/rag/suggestions?partial_text=æœºå™¨&max_suggestions=5`

æ ¹æ®éƒ¨åˆ†è¾“å…¥æ–‡æœ¬è·å–çƒ­è¯è¡¥å…¨å»ºè®®ã€‚

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "partial_text": "æœºå™¨",
  "suggestions": [
    "æœºå™¨å­¦ä¹ ",
    "æœºå™¨äºº",
    "æœºå™¨è§†è§‰",
    "æœºå™¨ç¿»è¯‘"
  ],
  "count": 4
}
```

### ğŸ“‹ æ‰¹é‡æ“ä½œæ¥å£

**POST** `/rag/index/bulk-add`

æ‰¹é‡æ·»åŠ çƒ­è¯åˆ°ç´¢å¼•ä¸­ã€‚

**è¯·æ±‚å‚æ•°ï¼š**

```json
{
  "words": [
    {"word": "è‡ªç„¶è¯­è¨€å¤„ç†", "weight": 8},
    {"word": "è®¡ç®—æœºè§†è§‰", "weight": 7},
    {"word": "è¯­éŸ³è¯†åˆ«", "weight": 9}
  ]
}
```

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "success": true,
  "message": "æ‰¹é‡æ·»åŠ å®Œæˆï¼šæ–°å¢ 3 ä¸ªï¼Œè·³è¿‡ 0 ä¸ª",
  "details": {
    "added": 3,
    "skipped": 0,
    "total_processed": 3
  }
}
```

### ğŸ”§ æ¨¡å‹ä¿¡æ¯æ¥å£

**GET** `/rag/model/info`

è·å–å½“å‰ä½¿ç”¨çš„å‘é‡åŒ–æ¨¡å‹è¯¦ç»†ä¿¡æ¯ã€‚

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "model_name": "sentence-transformers/all-MiniLM-L6-v2",
  "dimension": 384,
  "max_sequence_length": 256,
  "languages": ["zh", "en", "multilingual"],
  "description": "è½»é‡çº§å¤šè¯­è¨€å¥å­åµŒå…¥æ¨¡å‹ï¼Œé€‚åˆä¸­è‹±æ–‡æ··åˆåœºæ™¯",
  "performance": {
    "embedding_speed": "~1000 sentences/sec (CPU)",
    "model_size": "~90MB",
    "accuracy": "é€‚ä¸­ï¼Œå¹³è¡¡é€Ÿåº¦ä¸å‡†ç¡®æ€§"
  }
}
```

## ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1ï¼šå®æ—¶è½¬å†™ä¸­çš„çƒ­è¯é¢„æµ‹

```python
import requests

# ç”¨æˆ·è¯´è¯å†…å®¹
transcription = "ä»Šå¤©æˆ‘ä»¬è®¨è®ºäººå·¥æ™ºèƒ½åœ¨åŒ»ç–—é¢†åŸŸçš„åº”ç”¨"

# æœç´¢ç›¸å…³çƒ­è¯
response = requests.post("http://localhost:8000/rag/search", 
    headers={"Authorization": "Bearer YOUR_JWT_TOKEN"},
    json={
        "query": transcription,
        "top_k": 10,
        "threshold": 0.4
    }
)

results = response.json()
# æ ¹æ®æœç´¢ç»“æœè¿›è¡Œè½¬å†™å¢å¼º...
```

### åœºæ™¯2ï¼šçƒ­è¯è¾“å…¥è‡ªåŠ¨è¡¥å…¨

```python
# ç”¨æˆ·è¾“å…¥éƒ¨åˆ†æ–‡æœ¬
partial_input = "æ·±åº¦"

# è·å–è¡¥å…¨å»ºè®®
response = requests.get(
    f"http://localhost:8000/rag/suggestions?partial_text={partial_input}&max_suggestions=5",
    headers={"Authorization": "Bearer YOUR_JWT_TOKEN"}
)

suggestions = response.json()["suggestions"]
# ["æ·±åº¦å­¦ä¹ ", "æ·±åº¦ç¥ç»ç½‘ç»œ", "æ·±åº¦å¼ºåŒ–å­¦ä¹ ", ...]
```

### åœºæ™¯3ï¼šç³»ç»Ÿæ€§èƒ½ç›‘æ§

```python
# è·å–ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯
stats_response = requests.get("http://localhost:8000/rag/index/stats",
    headers={"Authorization": "Bearer YOUR_JWT_TOKEN"})

stats = stats_response.json()
print(f"ç”¨æˆ·çƒ­è¯æ•°é‡: {stats['total_hotwords']}")
print(f"ç´¢å¼•ç»´åº¦: {stats['index_dimension']}")
print(f"ç´¢å¼•çŠ¶æ€: {'å·²åˆå§‹åŒ–' if stats['is_initialized'] else 'æœªåˆå§‹åŒ–'}")
```

## æ€§èƒ½ç‰¹æ€§

### ğŸš€ **æŸ¥è¯¢æ€§èƒ½**

- **å“åº”æ—¶é—´**: < 50ms (å…¸å‹åœºæ™¯)
- **ååé‡**: > 100 QPS (å•å®ä¾‹)
- **å†…å­˜å ç”¨**: ~200MB (1000ä¸ªçƒ­è¯)

### ğŸ“ˆ **æ‰©å±•æ€§**

- **çƒ­è¯æ•°é‡**: æ”¯æŒæ¯ç”¨æˆ·1000+çƒ­è¯
- **å¹¶å‘ç”¨æˆ·**: æ”¯æŒ100+å¹¶å‘ç”¨æˆ·
- **ç´¢å¼•å¤§å°**: æ¯1000ä¸ªçƒ­è¯çº¦1.5MBå­˜å‚¨

### ğŸ”§ **é…ç½®ä¼˜åŒ–**

åœ¨ `asr_system_backend/env.example` ä¸­å¯è°ƒæ•´ä»¥ä¸‹å‚æ•°ï¼š

```bash
# RAGæœåŠ¡é…ç½®
RAG_MODEL_NAME=sentence-transformers/all-MiniLM-L6-v2
RAG_SIMILARITY_THRESHOLD=0.5

# æ€§èƒ½é…ç½®  
BACKGROUND_TASK_WORKERS=2
```

## éƒ¨ç½²å»ºè®®

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

1. **ä½¿ç”¨æ›´å¼ºå¤§çš„ç¡¬ä»¶**

   ```bash
   # æ¨èé…ç½®
   CPU: 4æ ¸å¿ƒä»¥ä¸Š
   å†…å­˜: 8GBä»¥ä¸Š
   å­˜å‚¨: SSDå­˜å‚¨æå‡ç´¢å¼•I/Oæ€§èƒ½
   ```
2. **æ¨¡å‹ç¼“å­˜ä¼˜åŒ–**

   ```bash
   # é¢„ä¸‹è½½æ¨¡å‹åˆ°æœ¬åœ°
   export TRANSFORMERS_CACHE=/path/to/model/cache
   ```
3. **ç´¢å¼•æ–‡ä»¶å¤‡ä»½**

   ```bash
   # å®šæœŸå¤‡ä»½ç´¢å¼•ç›®å½•
   cp -r temp/rag_indices/ /backup/rag_indices_$(date +%Y%m%d)/
   ```

### ç›‘æ§ä¸ç»´æŠ¤

1. **å¥åº·æ£€æŸ¥**

   ```bash
   # æ·»åŠ åˆ°ç›‘æ§ç³»ç»Ÿ
   curl -f http://localhost:8000/rag/health || exit 1
   ```
2. **æ—¥å¿—ç›‘æ§**

   ```bash
   # å…³æ³¨å…³é”®æ—¥å¿—
   grep "RAGæœåŠ¡" app.log
   grep "ç´¢å¼•é‡å»º" app.log
   ```
3. **æ€§èƒ½ç›‘æ§**

   ```python
   # å®šæœŸæ£€æŸ¥æœåŠ¡ç»Ÿè®¡
   GET /rag/index/stats
   ```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: æœåŠ¡å¯åŠ¨æ—¶æç¤º"æ¨¡å‹ä¸‹è½½å¤±è´¥"**

```bash
# è§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨ä¸‹è½½æ¨¡å‹
python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('sentence-transformers/all-MiniLM-L6-v2')"
```

**Q: æœç´¢ç»“æœä¸ºç©º**

```bash
# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰çƒ­è¯æ•°æ®
GET /rag/index/stats

# å¦‚æœçƒ­è¯ä¸º0ï¼Œå…ˆæ·»åŠ çƒ­è¯
POST /hotwords
```

**Q: ç´¢å¼•æ–‡ä»¶æŸå**

```bash
# å¼ºåˆ¶é‡å»ºç´¢å¼•
POST /rag/index/rebuild
```

## æŠ€æœ¯ç»†èŠ‚

### å‘é‡åŒ–æ¨¡å‹é€‰æ‹©

é€‰æ‹© `all-MiniLM-L6-v2` çš„åŸå› ï¼š

- **å¤šè¯­è¨€æ”¯æŒ**: æ”¯æŒä¸­è‹±æ–‡æ··åˆåœºæ™¯
- **æ¨¡å‹å¤§å°**: ä»…90MBï¼Œé€‚åˆéƒ¨ç½²
- **å‡†ç¡®æ€§**: åœ¨å¥å­ç›¸ä¼¼åº¦ä»»åŠ¡ä¸Šè¡¨ç°ä¼˜ç§€
- **é€Ÿåº¦**: CPUä¸Šå¯è¾¾1000å¥/ç§’çš„å¤„ç†é€Ÿåº¦

### FAISSç´¢å¼•ç­–ç•¥

ä½¿ç”¨ `IndexFlatIP` çš„è€ƒè™‘ï¼š

- **ç²¾ç¡®æœç´¢**: ä¿è¯100%å‡†ç¡®çš„ç›¸ä¼¼åº¦è®¡ç®—
- **ç®€å•å¯é **: æ— éœ€è°ƒå‚ï¼Œç¨³å®šæ€§å¥½
- **å†…å­˜æ•ˆç‡**: å¯¹äºä¸­å°è§„æ¨¡æ•°æ®é›†æœ€ä¼˜

### æ•°æ®éš”ç¦»è®¾è®¡

æ¯ä¸ªç”¨æˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»ï¼š

- **ç´¢å¼•æ–‡ä»¶**: `user_{user_id}.index`
- **å…ƒæ•°æ®æ–‡ä»¶**: `user_{user_id}.metadata`
- **å†…å­˜ç»“æ„**: æŒ‰ç”¨æˆ·IDåˆ†åˆ«å­˜å‚¨

## å¼€å‘ä¸è´¡çŒ®

### æœ¬åœ°å¼€å‘

```bash
# å…‹éš†é¡¹ç›®
git clone <project-url>

# å®‰è£…å¼€å‘ä¾èµ–
pip install -r requirements.txt

# è¿è¡Œæµ‹è¯•
pytest test/test_rag.py

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
uvicorn app.main:app --reload
```

### ä»£ç ç»“æ„

```
asr_system_backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â””â”€â”€ rag.py           # RAG APIè·¯ç”±
â”‚   â”œâ”€â”€ rag_service.py       # æ ¸å¿ƒRAGæœåŠ¡
â”‚   â””â”€â”€ main.py             # ä¸»åº”ç”¨å…¥å£
â”œâ”€â”€ temp/
â”‚   â””â”€â”€ rag_indices/        # ç´¢å¼•æ–‡ä»¶å­˜å‚¨
â””â”€â”€ test/
    â””â”€â”€ test_rag.py         # RAGåŠŸèƒ½æµ‹è¯•
```

## ç‰ˆæœ¬å†å²

- **v1.0.0** (2025-07-11)
  - åˆå§‹POCç‰ˆæœ¬å‘å¸ƒ
  - åŸºç¡€å‘é‡æœç´¢åŠŸèƒ½
  - ç´¢å¼•æŒä¹…åŒ–æ”¯æŒ
  - å¤šç”¨æˆ·éš”ç¦»æœºåˆ¶

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ï¼Œè¯¦è§LICENSEæ–‡ä»¶ã€‚

---

**è‡´è°¢**
æ„Ÿè°¢sentence-transformerså’ŒFAISSå¼€æºé¡¹ç›®ä¸ºæœ¬POCæä¾›çš„æŠ€æœ¯åŸºç¡€ã€‚
